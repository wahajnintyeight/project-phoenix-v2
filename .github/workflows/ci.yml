name: Build and Deploy (changed only)

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect changes
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            apigateway:
              - 'pkg/service/apigateway/**'
              - 'pkg/**'
              - 'internal/**'
              - 'go.mod'
            apigateway_grpc:
              - 'pkg/service/apigateway-grpc/**'
              - 'pkg/**'
              - 'internal/**'
              - 'go.mod'
            datacommunicator:
              - 'pkg/service/datacommunicator/**'
              - 'pkg/**'
              - 'internal/**'
              - 'go.mod'
            locationservice:
              - 'pkg/service/locationservice/**'
              - 'pkg/**'
              - 'internal/**'
              - 'go.mod'
            socketservice:
              - 'pkg/service/socketservice/**'
              - 'pkg/**'
              - 'internal/**'
              - 'go.mod'
            sse_service:
              - 'pkg/service/sse-service/**'
              - 'pkg/**'
              - 'internal/**'
              - 'go.mod'

      - name: Set up QEMU & Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.x'

      - name: Prepare Go modules (tidy and vendor)
        run: |
          go env -w GOPROXY=https://proxy.golang.org,direct
          go mod tidy
          go mod vendor

      - name: Login to GHCR
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Compute targets
        id: list
        run: |
          # Map filters to service folder names
          changed=()
          [ "${{ steps.changes.outputs.apigateway }}" = "true" ] && changed+=("pkg/service/apigateway")
          [ "${{ steps.changes.outputs.apigateway_grpc }}" = "true" ] && changed+=("pkg/service/apigateway-grpc")
          [ "${{ steps.changes.outputs.datacommunicator }}" = "true" ] && changed+=("pkg/service/datacommunicator")
          [ "${{ steps.changes.outputs.locationservice }}" = "true" ] && changed+=("pkg/service/locationservice")
          [ "${{ steps.changes.outputs.socketservice }}" = "true" ] && changed+=("pkg/service/socketservice")
          [ "${{ steps.changes.outputs.sse_service }}" = "true" ] && changed+=("pkg/service/sse-service")
          
          if [ ${#changed[@]} -eq 0 ]; then
             echo "none=true" >> $GITHUB_OUTPUT
          else
             echo "paths=${changed[*]}" >> $GITHUB_OUTPUT
             echo "none=false" >> $GITHUB_OUTPUT
          fi

      - name: Build changed
        if: steps.list.outputs.none == 'false'
        run: |
          IFS=' ' read -r -a paths <<< "${{ steps.list.outputs.paths }}"
          for path in "${paths[@]}"; do
            # Extract service name (e.g., 'pkg/service/apigateway' -> 'apigateway')
            svc_name=$(basename "$path")
            
            echo "Building $svc_name from $path"
            
            # Point to the specific Dockerfile inside the service folder
            docker buildx build \
              --file "$path/Dockerfile" \
              --build-arg SERVICE_PATH="$path" \
              --platform linux/amd64 \
              --tag "ghcr.io/${{ github.repository_owner }}/$svc_name:latest" \
              --cache-from type=gha \
              --cache-to type=gha,mode=max \
              $([ "${{ github.event_name }}" != "pull_request" ] && echo "--push") \
              .
          done

      - name: Deploy to VPS
        if: steps.list.outputs.none == 'false' && github.event_name != 'pull_request'
        uses: appleboy/ssh-action@v1.2.0
        env:
          PATHS: "${{ steps.list.outputs.paths }}"
          BRANCH: "${{ github.ref_name }}"
          GHCR_TOKEN: "${{ secrets.PAT }}"
          USER: ${{ github.actor }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          password: ${{ secrets.VPS_PASSWORD }}
          envs: PATHS,BRANCH,GHCR_TOKEN,USER
          script: |
            set -e
            cd /var/www/project-phoenix-v2
            
            # Safe update
            git pull origin "$BRANCH" || echo "Git pull failed (local changes?), continuing..."

            echo "$GHCR_TOKEN" | docker login ghcr.io -u "$USER" --password-stdin

            IFS=' ' read -r -a paths <<< "$PATHS"
            deploy_targets=()
            
            for path in "${paths[@]}"; do
              svc=$(basename "$path")
              # Map folder names to docker-compose service names
              case "$svc" in
                apigateway)       deploy_targets+=("api-gateway") ;;
                apigateway-grpc)  deploy_targets+=("api-gateway-grpc") ;;
                locationservice)  deploy_targets+=("location-service") ;;
                socketservice)    deploy_targets+=("socket-service") ;;
                sse-service)      deploy_targets+=("sse-service") ;;
              esac
            done

            if [ ${#deploy_targets[@]} -gt 0 ]; then
               echo "Rolling update for: ${deploy_targets[*]}"
               # Pull only changed images
               docker compose pull "${deploy_targets[@]}"
               # Recreation is fast because we use --no-deps
               docker compose -p ppv2 up -d --no-deps --wait "${deploy_targets[@]}"
               docker compose ps
            else
               echo "Only unmapped services (like datacommunicator) changed. No Compose update needed."
            fi